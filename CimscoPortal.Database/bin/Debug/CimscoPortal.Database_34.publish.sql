/*
Deployment script for CimscoPortal

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "CimscoPortal"
:setvar DefaultFilePrefix "CimscoPortal"
:setvar DefaultDataPath "c:\Program Files\Microsoft SQL Server\MSSQL11.SQLSERVER2012\MSSQL\DATA\"
:setvar DefaultLogPath "c:\Program Files\Microsoft SQL Server\MSSQL11.SQLSERVER2012\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Creating [dbo].[InvoiceSummaries]...';


GO
CREATE TABLE [dbo].[InvoiceSummaries] (
    [PreviousBalance]                DECIMAL (10, 2) NOT NULL,
    [PaymentsReceived]               DECIMAL (10, 2) NOT NULL,
    [PaymentReceivedDate]            DATE            NOT NULL,
    [PromptPaymentDiscountReceived]  DECIMAL (10, 2) NOT NULL,
    [PromptPaymentDiscountAvailable] DECIMAL (10, 2) NOT NULL,
    [PromptPaymentDueDate]           DATE            NOT NULL,
    [TotalOwing]                     DECIMAL (10, 2) NOT NULL,
    [GstTotal]                       DECIMAL (8, 2)  NOT NULL,
    [InvoiceTotal]                   DECIMAL (10, 2) NOT NULL,
    [AccountNumber]                  NVARCHAR (12)   NOT NULL,
    [CustomerNumber]                 NVARCHAR (12)   NOT NULL,
    [AccountManager]                 NVARCHAR (50)   NOT NULL,
    [GSTCharges]                     DECIMAL (8, 2)  NOT NULL,
    [SupplierName]                   NVARCHAR (50)   NULL,
    [InvoiceDate]                    DATE            NOT NULL,
    [PeriodStart]                    DATE            NOT NULL,
    [PeriodStop]                     DATE            NOT NULL,
    [CustomerName]                   NVARCHAR (50)   NULL,
    [ConnectionNumber]               NVARCHAR (30)   NULL,
    [SiteId]                         INT             NOT NULL,
    [TotalCharges]                   DECIMAL (8, 2)  NOT NULL,
    [MiscChargesTotal]               DECIMAL (10, 2) NOT NULL,
    [EnergyChargesTotal]             DECIMAL (10, 2) NOT NULL,
    [SiteName]                       NVARCHAR (50)   NULL,
    [InvoiceSummaryId]               INT             IDENTITY (1, 1) NOT NULL,
    CONSTRAINT [PK_InvoiceSummaries] PRIMARY KEY CLUSTERED ([InvoiceSummaryId] ASC)
) ON [PRIMARY];


GO
/*
Post-Deployment Script Template							
--------------------------------------------------------------------------------------
 This file contains SQL statements that will be appended to the build script.		
 Use SQLCMD syntax to include a file in the post-deployment script.			
 Example:      :r .\myfile.sql								
 Use SQLCMD syntax to reference a variable in the post-deployment script.		
 Example:      :setvar TableName MyTable							
               SELECT * FROM [$(TableName)]					
--------------------------------------------------------------------------------------
*/
delete from dbo.PortalMessages
delete from dbo.MessageCategories
delete from dbo.MessageTypes
delete from dbo.InvoiceSummaries


GO
SET IDENTITY_INSERT [dbo].[MessageCategories] ON
INSERT INTO [dbo].[MessageCategories] ([MessageCategoryId], [CategoryName], [Element1], [Element2]) VALUES (2, N'alert-phone-blue', N'fa fa-phone bg-themeprimary white', N'fa fa-clock-o themeprimary')
INSERT INTO [dbo].[MessageCategories] ([MessageCategoryId], [CategoryName], [Element1], [Element2]) VALUES (4, N'alert-tick-red', N'fa fa-check bg-darkorange white', N'fa fa-clock-o darkorange')
INSERT INTO [dbo].[MessageCategories] ([MessageCategoryId], [CategoryName], [Element1], [Element2]) VALUES (5, N'alert-event-orange', N'fa fa-gift bg-warning white', N'fa fa-calendar warning')
SET IDENTITY_INSERT [dbo].[MessageCategories] OFF

GO
SET IDENTITY_INSERT [dbo].[MessageTypes] ON
INSERT INTO [dbo].[MessageTypes] ([MessageTypeId], [TypeName], [TypeElement]) VALUES (1, N'Alert', N'pg-alert')
INSERT INTO [dbo].[MessageTypes] ([MessageTypeId], [TypeName], [TypeElement]) VALUES (2, N'Mail', N'pg-mail')
INSERT INTO [dbo].[MessageTypes] ([MessageTypeId], [TypeName], [TypeElement]) VALUES (3, N'Task', N'pg-task')
INSERT INTO [dbo].[MessageTypes] ([MessageTypeId], [TypeName], [TypeElement]) VALUES (4, N'Chat', N'pg-chat')
SET IDENTITY_INSERT [dbo].[MessageTypes] OFF

GO
delete from [dbo].[Customers] 
SET IDENTITY_INSERT [dbo].[Customers] ON
INSERT INTO [dbo].[Customers] ([CustomerId], [CustomerName]) VALUES (1, N'Customer1')
SET IDENTITY_INSERT [dbo].[Customers] OFF

GO
/*
SET IDENTITY_INSERT [dbo].[PortalMessages] ON
INSERT INTO [dbo].[PortalMessages] ([PortalMessageId], [CustomerId], [MessageCategoryId], [Message], [MessageTypeId]) 
	VALUES (1, 
			(select CustomerId from dbo.Customers where CustomerName = 'Customer1'), 
			(select MessageCategoryId from dbo.MessageCategories where CategoryName = 'alert-phone-blue'), 
			N'Test phone message', 
			(select MessageTypeId from dbo.MessageTypes where [TypeName] = 'Alert')
			)
INSERT INTO [dbo].[PortalMessages] ([PortalMessageId], [CustomerId], [MessageCategoryId], [Message], [MessageTypeId]) 
	VALUES (2, 
			(select CustomerId from dbo.Customers where CustomerName = 'Customer1'), 
			(select MessageCategoryId from dbo.MessageCategories where CategoryName = 'alert-tick-red'), 
			N'Test tick message', 
			(select MessageTypeId from dbo.MessageTypes where [TypeName] = 'Alert')
			)
SET IDENTITY_INSERT [dbo].[PortalMessages] OFF
*/
SET IDENTITY_INSERT [dbo].[PortalMessages] ON
INSERT INTO [dbo].[PortalMessages] ([PortalMessageId], [CustomerId], [MessageCategoryId], [Message], [MessageTypeId], [MessageFormatId], [TimeStamp], [Footer], [ExpiryDate]) VALUES (1, 1, 2, N'Test phone message', 1, NULL, N'2015-03-25 02:30:00', N'Test footer', N'2015-03-01 00:00:00')
INSERT INTO [dbo].[PortalMessages] ([PortalMessageId], [CustomerId], [MessageCategoryId], [Message], [MessageTypeId], [MessageFormatId], [TimeStamp], [Footer], [ExpiryDate]) VALUES (2, 1, 4, N'Test tick message', 1, NULL, N'2015-03-25 03:45:00', N'Test footer2', N'2015-04-01 00:00:00')
SET IDENTITY_INSERT [dbo].[PortalMessages] OFF





GO
/****** Script for SelectTopNRows command from SSMS  ******/
use CimscoNZ
GO

SELECT    Invoices.PreviousBalance AS PreviousBalance, Invoices.PaymentsReceived AS PaymentsReceived, Invoices.PaymentReceivedDate AS PaymentReceivedDate, Invoices.PromptPaymentDiscountReceived AS PromptPaymentDiscountReceived, 
                         Invoices.PromptPaymentDiscountAvailable AS PromptPaymentDiscountAvailable, Invoices.PromptPaymentDueDate AS PromptPaymentDueDate, Invoices.TotalOwing AS TotalOwing, Invoices.GstTotal AS GstTotal, Invoices.InvoiceTotal AS InvoiceTotal, 
                         Invoices.AccountNumber AS AccountNumber, Invoices.CustomerNumber AS CustomerNumber, Invoices.AccountManager AS AccountManager, Invoices.GSTCharges AS GSTCharges, EnergySuppliers.SupplierName, Invoices.InvoiceDate, 
                         Invoices.PeriodStart, Invoices.PeriodStop, Customers.CustomerName, EnergyPoints.ConnectionNumber, Invoices.SiteId, Invoices.TotalCharges, Invoices.MiscChargesTotal, Invoices.EnergyChargesTotal, 
                         Sites.SiteName
into   [CimscoPortal].[dbo].[InvoiceSummaries]  
FROM            Sites LEFT OUTER JOIN
                         EnergyPoints INNER JOIN
                         EnergySuppliers ON EnergyPoints.SupplierId = EnergySuppliers.SupplierId ON Sites.SiteId = EnergyPoints.SiteId RIGHT OUTER JOIN
                         Invoices ON EnergySuppliers.SupplierId = Invoices.EnergySupplierId AND Sites.SiteId = Invoices.SiteId LEFT OUTER JOIN
                         Customers ON Sites.CustomerId = Customers.CustomerId AND Invoices.CustomerId = Customers.CustomerId
GO


GO

GO
PRINT N'Update complete.';


GO
